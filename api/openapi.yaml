openapi: 3.0.0
info:
  title: Mithlond Agent API
  version: 0.1.0
  license:
    name: O'Sassy
    url: https://osaasy.dev/
  description: |
    Server agent API for handling deployments, updates, and health checks.
    This agent is installed on servers/VPS instances and communicates with the Mithlond platform.

servers:
  - url: http://localhost:8080
    description: Local development server

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authenticating requests from the Mithlond platform

  schemas:
    AppActionRequest:
      type: object
      required:
        - app_slug
        - environment
      properties:
        app_slug:
          type: string
        environment:
          type: string
    AppActionResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        output:
          type: string

    CreateBinaryAppRequest:
      type: object
      required:
        - asset_url
        - app_id
        - deployment_id
        - team_id
        - environment_id
        - artifact_source
        - artifact_name
        - artifact_version
        - callback_url
        - domain
        - port
      properties:
        asset_url:
          type: string
        app_id:
          type: string
        deployment_id:
          type: string
        team_id:
          type: string
        environment_id:
          type: string
        artifact_source:
          type: string
        artifact_version:
          type: string
        artifact_name:
          type: string
        callback_url:
          type: string
          format: uri
        domain:
          type: string
        env_vars:
          type: object
          additionalProperties:
            type: string
        port:
          type: integer

    DeployBinaryAppRequest:
      type: object
      required:
        - asset_url
        - team_id
        - deployment_id
        - app_id
        - environment_id
        - artifact_source
        - artifact_version
        - artifact_name
        - callback_url
        - domain
        - port
      properties:
        asset_url:
          type: string
        deployment_id:
          type: string
        team_id:
          type: string
        app_id:
          type: string
        environment_id:
          type: string
        artifact_source:
          type: string
        artifact_version:
          type: string
        artifact_name:
          type: string
        callback_url:
          type: string
          format: uri
        domain:
          type: string
        env_vars:
          type: object
          additionalProperties:
            type: string
        port:
          type: integer
        args:
          type: array
          items:
            type: string

    CreateDockerAppRequest:
      type: object
      required:
        - app_slug
        - environment
        - artifact_source
        - artifact_version
        - port
      properties:
        deployment_id:
          type: string
        app_slug:
          type: string
        environment:
          type: string
        artifact_source:
          type: string
        artifact_version:
          type: string
        callback_url:
          type: string
          format: uri
        domain:
          type: string
        env_vars:
          type: object
          additionalProperties:
            type: string
        port:
          type: integer
        docker_command:
          type: array
          items:
            type: string
        ports:
          type: array
          items:
            type: string
        volumes:
          type: array
          items:
            type: string

    DeployDockerAppRequest:
      type: object
      required:
        - app_slug
        - environment
        - artifact_source
        - artifact_version
      properties:
        deployment_id:
          type: string
        app_slug:
          type: string
        environment:
          type: string
        artifact_source:
          type: string
        artifact_version:
          type: string
        callback_url:
          type: string
          format: uri

    UpdateAgentRequest:
      type: object
      required:
        - artifact_version
      properties:
        artifact_version:
          type: string
        override_artifact_source:
          type: string
    UpdateAgentResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
    AgentDeployRequest:
      type: object
      required:
        - version
      properties:
        version:
          type: string
        checksum:
          type: string
        request_id:
          type: string
    AgentDeployResponse:
      type: object
      required:
        - deployment_id
        - state
      properties:
        deployment_id:
          type: string
        state:
          type: string
          enum: [queued, running, failed, succeeded, rolling_back]
    AgentDeploymentStatus:
      type: object
      required:
        - deployment_id
        - state
        - active_slot_before
        - active_slot_current
        - current_step
        - updated_at
      properties:
        deployment_id:
          type: string
        request_id:
          type: string
        target_version:
          type: string
        state:
          type: string
          enum: [queued, running, failed, succeeded, rolling_back]
        active_slot_before:
          type: string
          enum: [green, blue]
        active_slot_current:
          type: string
          enum: [green, blue]
        current_step:
          type: string
        error:
          type: string
          nullable: true
        started_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
        finished_at:
          type: string
          format: date-time
          nullable: true
    ReadyzResponse:
      type: object
      properties:
        status:
          type: string

    DeployResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        logs:
          type: string

    GenericObject:
      type: object
      additionalProperties: true

    HealthResponse:
      type: object
      required:
        - status
        - version
      properties:
        status:
          type: string
          enum: [healthy]
          example: healthy
        version:
          type: string
          example: "0.1.0"

paths:
  /health:
    get:
      operationId: getHealth
      summary: Health check
      description: Returns the health status and version of the agent.
      tags:
        - Health
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Agent is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"

  /agent/update:
    post:
      operationId: updateAgent
      summary: Update agent binary
      tags:
        - Agent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateAgentRequest"
      responses:
        "202":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"

  /v1/agent/deploy:
    post:
      operationId: deployAgent
      summary: Trigger asynchronous agent deployment
      tags:
        - Agent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AgentDeployRequest"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentDeployResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"

  /v1/agent/deploy/{deployment_id}:
    get:
      operationId: getAgentDeploymentStatus
      summary: Get deployment status
      tags:
        - Agent
      security:
        - ApiKeyAuth: []
      parameters:
        - name: deployment_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deployment status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentDeploymentStatus"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"

  /readyz:
    get:
      operationId: getReadyz
      summary: Readiness check
      tags:
        - Health
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadyzResponse"
        "503":
          description: Not ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"

  /metrics/node:
    get:
      operationId: getNodeMetrics
      summary: Proxy selected Prometheus node metrics
      tags:
        - Metrics
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObject"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentResponse"
        "503":
          description: Prometheus not available
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObject"

  /app/create/binary:
    post:
      operationId: createBinaryApp
      summary: Create binary app (install and start)
      tags:
        - App
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBinaryAppRequest"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"

  /app/create/docker:
    post:
      operationId: createDockerApp
      summary: Create docker app (install and start)
      tags:
        - App
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDockerAppRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"

  /app/deploy/binary:
    post:
      operationId: deployBinaryApp
      summary: Deploy binary app (update and restart)
      tags:
        - App
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeployBinaryAppRequest"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"

  /app/deploy/docker:
    post:
      operationId: deployDockerApp
      summary: Deploy docker app (update and restart)
      tags:
        - App
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeployDockerAppRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResponse"

  /app/start:
    post:
      operationId: startApp
      summary: Start app service
      tags:
        - App
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AppActionRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"

  /app/stop:
    post:
      operationId: stopApp
      summary: Stop app service
      tags:
        - App
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AppActionRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"

  /app/restart:
    post:
      operationId: restartApp
      summary: Restart app service
      tags:
        - App
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AppActionRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"
        "500":
          description: Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppActionResponse"
