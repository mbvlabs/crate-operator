openapi: 3.0.3
info:
  title: Mithlond Agent API
  version: "dev"
servers:
  - url: http://127.0.0.1:9000
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    DeploymentRequest:
      type: object
      required: [appName, envName, dockerComposeContent, envVars, port, enableHttps]
      properties:
        appName: { type: string }
        envName: { type: string }
        dockerComposeContent: { type: string }
        envVars:
          type: object
          additionalProperties: { type: string }
        registryAuth:
          $ref: "#/components/schemas/RegistryAuth"
        domain: { type: string }
        port: { type: integer }
        enableHttps: { type: boolean }
    RegistryAuth:
      type: object
      required: [type, url, username, password]
      properties:
        type: { type: string }
        url: { type: string }
        username: { type: string }
        password: { type: string }
    DeploymentResponse:
      type: object
      properties:
        success: { type: boolean }
        logs: { type: string }

    HealthResponse:
      type: object
      properties:
        status: { type: string }
        timestamp: { type: string }
        uptime: { type: string }

    VersionResponse:
      type: object
      properties:
        version: { type: string }
        buildTime: { type: string }

    PreDownloadRequest:
      type: object
      required: [binaryUrl, version]
      properties:
        binaryUrl: { type: string }
        version: { type: string }
        checksum: { type: string }
    PreDownloadResponse:
      type: object
      properties:
        status: { type: string }
        version: { type: string }
        message: { type: string }

    UpdateAgentRequest:
      type: object
      properties:
        version: { type: string }
        binaryUrl: { type: string }
    UpdateAgentResponse:
      type: object
      properties:
        status: { type: string }
        message: { type: string }

    AppHealthCheckRequest:
      type: object
      required: [appSlug]
      properties:
        appSlug: { type: string }
        domain: { type: string }
    AppHealthCheckResponse:
      type: object
      properties:
        healthy: { type: boolean }
        containerId: { type: string }
        httpStatus: { type: integer }
        httpResponse: { type: string }
        message: { type: string }

    AppActionResponse:
      type: object
      properties:
        status: { type: string }
        message: { type: string }
        output: { type: string }

    CheckUpdatesResponse:
      type: object
      properties:
        updatesAvailable: { type: boolean }
        securityUpdates: { type: integer }
        regularUpdates: { type: integer }
        rebootRequired: { type: boolean }
        packages:
          type: array
          items: { type: string }

    ApplyUpdatesRequest:
      type: object
      required: [updateType, autoReboot]
      properties:
        updateType:
          type: string
          enum: [security, full]
        autoReboot: { type: boolean }
    ApplyUpdatesResponse:
      type: object
      properties:
        status: { type: string }
        updatedPackages: { type: integer }
        rebootRequired: { type: boolean }
        logs: { type: string }
        packages:
          type: array
          items: { type: string }

    GenericObject:
      type: object
      additionalProperties: true

    CaddyLogsResponse:
      type: object
      properties:
        logs: { type: string }
        path: { type: string }
        lines: { type: string }

paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/HealthResponse" }

  /version:
    get:
      summary: Version info
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/VersionResponse" }

  /webhook/deploy:
    post:
      summary: Deploy app via docker-compose
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeploymentRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DeploymentResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DeploymentResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DeploymentResponse" }

  /pre-download:
    post:
      summary: Pre-download agent binary
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PreDownloadRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PreDownloadResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PreDownloadResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PreDownloadResponse" }

  /update:
    post:
      summary: Update agent binary
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdateAgentRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UpdateAgentResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UpdateAgentResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UpdateAgentResponse" }

  /app/health-check:
    post:
      summary: Check app container health
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AppHealthCheckRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppHealthCheckResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppHealthCheckResponse" }

  /metrics/node:
    get:
      summary: Proxy selected Prometheus node metrics
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }
        "503":
          description: Prometheus not available
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /metrics/prometheus:
    get:
      summary: Proxy Prometheus query (up)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /app/{name}/restart:
    post:
      summary: Restart app service
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }

  /app/{name}/stop:
    post:
      summary: Stop app service
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }

  /app/{name}/start:
    post:
      summary: Start app service
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }

  /caddy/start:
    post:
      summary: Enable and start Caddy
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AppActionResponse" }

  /logs/caddy/access:
    get:
      summary: Tail Caddy access logs
      security:
        - bearerAuth: []
      parameters:
        - name: lines
          in: query
          required: false
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CaddyLogsResponse" }
        "404":
          description: Not Found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /logs/caddy/agent:
    get:
      summary: Tail Caddy agent access logs
      security:
        - bearerAuth: []
      parameters:
        - name: lines
          in: query
          required: false
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CaddyLogsResponse" }
        "404":
          description: Not Found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /logs/caddy/apps:
    get:
      summary: Tail Caddy apps access logs
      security:
        - bearerAuth: []
      parameters:
        - name: lines
          in: query
          required: false
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CaddyLogsResponse" }
        "404":
          description: Not Found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /caddy/metrics:
    get:
      summary: Proxy Caddy metrics
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            text/plain:
              schema: { type: string }
        "503":
          description: Caddy not available
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /caddy/config:
    get:
      summary: Proxy Caddy config
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }
        "503":
          description: Caddy not available
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /system/check-updates:
    post:
      summary: Check system updates
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CheckUpdatesResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenericObject" }

  /system/update:
    post:
      summary: Apply system updates
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ApplyUpdatesRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApplyUpdatesResponse" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApplyUpdatesResponse" }
        "500":
          description: Server Error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApplyUpdatesResponse" }
